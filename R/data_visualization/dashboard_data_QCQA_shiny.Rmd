---
title: "Data QCQA" 
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
runtime: shiny
---

```{r global, include=FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
library(datasets)
library(flexdashboard)
library(shiny)
library(dplyr)
library(plotly)
library(ggplot2)
library(ggpubr)
library(forecast)
library(lubridate)
library(hms)
library(gridExtra)
library(amerifluxr)
library(heatmaply)
library(data.table)
library(ggpmisc)
library(knitr)
```
```{r echo=FALSE}
# Comments/Notes
# 1) See if want to update sonic, temperature, and rad plots using multiple_plotlys

# 2) NEED TO ADD 7200, 7700 temp and 7200 RH & CHECK WHICH TEMP IS USED TO SONIC (cross wind corrected or no) ADD HERE after MEETING ON THURSDAY!
# 3) Try to track down WD_CUP at all sites
# 4) Remove duplicate variables (e.g., see google sheets for tracking)
# 5) Think about output directory (can change by replacing 'dirname(inputFile)' above)
# 6) Add EBC
```

<!-- specify init file to read -->
```{r echo=FALSE, include=FALSE}
read_chunk('ini_files/DSM_v2_data_QCQA.R')
```

```{r, echo=FALSE, include=FALSE}
<<LoadData>>
```

Sonic data 
=======================================================================

Column {data-width=600}
-----------------------------------------------------------------------

### Sonic variables and diagnostics

```{r}
sonic_plots(data,vars_WS,vars_WD,vars_other_sonic,units_other_sonic,pitch_ind)
```

Column {data-width=400}
-----------------------------------------------------------------------

### mean wind speed vs. u*
```{r}
scatter_plot_QCQA(data,vars_WS[1],vars_other_sonic[1],
                  "WS (m/s)","USTAR (m/s)",0)
```

### sigma_w vs. u*
```{r}
scatter_plot_QCQA(data,vars_other_sonic[1],
                  wind_std,
                  "USTAR (m/s)","W_SIGMA (m/s)",0)
```

Temp/RH 
=======================================================================

Column {data-width=600}
-----------------------------------------------------------------------

### Air and RH temperature comparison 
```{r}
temp_RH_plots(data,vars_temp,vars_RH)
```

Column {data-width=400}
-----------------------------------------------------------------------

### Temperature scatterplot
```{r}
scatter_plot_QCQA(data,vars_temp[1],vars_temp[2],"HMP Air temperature (°C)","Other Air Temperature (°C)",0)
```

### RH HMP vs. RH 7200

```{r}
scatter_plot_QCQA(data,vars_RH[1],vars_RH[2], "HMP RH (%)","LI-7200 RH (%)",0)
```

Radiation Time Series 
=======================================================================

Column {data-width=600}
-----------------------------------------------------------------------

### Radiation timeseries  
```{r}
radiation_plots(data,vars_radiometer,vars_NETRAD,vars_PPFD,var_potential_rad)
```

Column {data-width=400}
-----------------------------------------------------------------------

### SW_IN vs PPDF_IN
```{r}
scatter_plot_QCQA(data,vars_radiometer[1],vars_PPFD[1], "SW_IN (W/m2)","PPFD_IN (µmolPhoton/m2/s1)",0)
```

### SW_IN vs PPDF_IN R2 and Slope

```{r}
R2_slope_QCQA(data,vars_radiometer[1],vars_PPFD[1])
```

Radiation Diagnostics
=======================================================================

Row 
-----------------------------------------------------------------------

### Checking for offsets between SW_IN (blue) and potential radiation (red)  
```{r}
# Compute mean diurnal pattern for 15 day moving window
diurnal.composite <- diurnal.composite.rad(data,var_potential_rad,vars_radiometer[1],vars_PPFD[1],15,48)
diurnal.composite <- diurnal.composite[is.finite(diurnal.composite$potential_radiation), ]

SWIN_vs_potential_rad(diurnal.composite)
```

### Cross between SW_IN and potential radiation
```{r}
p <- xcorr_rad(diurnal.composite)
toWebGL(p[[1]])
```

Row 
------------------------------------------------------------------------

### Checking for offsets between PPFD_IN (green) and potential radiation (red)  
```{r}
PPFDIN_vs_potential_rad(diurnal.composite)
```

### Cross correlation analysis between PPDF_IN and potential radiation
```{r}
p <- xcorr_rad(diurnal.composite)
toWebGL(p[[2]])
```

Pressure 
=======================================================================

Column {data-width=600}
-----------------------------------------------------------------------

### Pressure 
```{r}
# Barometric pressure 
#plotly_loop(data,vars_pressure,"Barometric pressure (kPa)")
```

Column {data-width=400}
-----------------------------------------------------------------------

### Pressure comparison (Met PA vs EC PA)
```{r}

```

Met time series
=======================================================================

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
selectInput('y', 'Variable', names(data[, !names(data) %in% c("datetime")])) 
```

Column
-----------------------------------------------------------------------

### Time series of single met variable

```{r}
dataset <- reactive({
  data[, c(input$x, input$y)]
})

renderPlotly({
  plot_ly(data, x = ~datetime, y = ~data[[input$y]], type = 'scatter', mode = 'lines') %>%
    layout(yaxis = list(title = input$y)) %>%
    toWebGL() 
})
```

Met diurnal pattern
=======================================================================

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
selectInput('z', 'Variable', names(data[, !names(data) %in% c("datetime")])) 
```

Column
-----------------------------------------------------------------------

### Diurnal pattern of single met variable

```{r}

dataset <- reactive({
  diurnal.summary(data, input$z, 30, 15)
  
})

renderPlotly({
  
  diurnal.summary.composite <- dataset() %>%
    group_by(firstdate,HHMM) %>%
    dplyr::summarize(var = median(var, na.rm = TRUE),
                     HHMM = first(HHMM))
  diurnal.summary.composite$time <- as.POSIXct(as.character(diurnal.summary.composite$HHMM), format="%R", tz="UTC")
  
  p <- ggplot() +
    geom_point(data = dataset(), aes(x = time, y = var),color = 'Grey',size = 0.1) +
    geom_line(data = diurnal.summary.composite, aes(x = time, y = var),color = 'Black') +
    scale_x_datetime(breaks="6 hours", date_labels = "%H") + ylab(input$z)
  p <- ggplotly(p+ facet_wrap(~as.factor(firstdate))) %>% toWebGL()
  p
  
})
```

Flux time series - WORK STARTING HERE!
=======================================================================

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
selectInput('f', 'Variable Second Stage', names(data[, !names(data) %in% c("datetime")])) 
selectInput('f3', 'Variable Third Stage', names(data_thirdstage[, !names(data_thirdstage) %in% c("datetime")])) 
```

Column
-----------------------------------------------------------------------

### Time series of single met variable

```{r}
dataset_second <- reactive({
  data[, c(input$x, input$f)]
})

dataset_third <- reactive({
  data_thirdstage[, c(input$x, input$f3)]
})

renderPlotly({
  plot_ly(dataset_second, x = ~datetime, y = ~data[[input$y]], type = 'scatter', mode = 'lines') %>%
    layout(yaxis = list(title = input$f)) %>%
    toWebGL() 
})
```
